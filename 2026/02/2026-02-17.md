[[Nginx]] 踩坑记录：Websocket 连接协议未启用

部分 Web App 在开启反向代理后访问会遇到如下问题

```txt
handle command failed: websocket: the client is not using the websocket protocol: 'upgrade' token not found in 'Connection' header
```

原因是前后端建立了 Websocket，但是反向代理把升级协议的请求头去掉了。对于 Nginx，只要把 Websockets Support 加上即可，对应配置如下

```txt
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
```

---

[[Forgejo]] 的名字来源于世界语中的单词 Forĝejo，在世界语中

- forĝi：含义为锻造
- -ejo 后缀：表示一个场所、地方

因此 Forĝejo 的意思就是“锻造厂”。

> 既然 Codeberg 创立 Forgejo 是为了反抗 Gitea 的“商业化霸权”和“公司控制”，发誓要打造一个绝对自由、只属于公共利益的软件，那么还有什么比用“世界语”来命名它更合适的呢？ -- Gemini 3.0 Pro

---

[[Nginx Proxy Manager]] 常见配置说明

**Cache Assets (缓存静态资源)：**

作用：让 Nginx 把后端的静态文件（比如图片、CSS 样式表、JS 脚本）缓存在 NPM 的内存或硬盘里。当有新用户访问时，NPM 直接把缓存丢给用户，不再去打扰你后端的真实服务。

使用建议：对于静态博客、导航页，打开它能极大提升网页加载速度并降低后端服务器压力。但对于你正在开发调试的 Web App 或者私人网盘，强烈建议关闭。否则你很容易遇到“我明明改了前端代码，怎么网页上还是旧版”的灵异事件。

**Block Common Exploits (拦截常见漏洞攻击)：**

作用：相当于一个超轻量级的 Web 应用防火墙 (WAF)。它会在底层配置拦截规则，比如屏蔽恶意爬虫、拦截 SQL 注入特征的 URL、阻止外界访问 .git 或 .env 等隐藏文件。

使用建议：一般建议打开以防“网络扫雷机”。但是，如果你部署了一些比较老旧的开源软件，或者你自己写的 API 接口请求头不够规范，开启这个选项极其容易导致误杀（报 403 Forbidden 或 502 Bad Gateway）。如果你的某个应用莫名其妙保存不了设置，第一件事就是把这个开关关掉试试。

**Websockets Support (支持 WebSocket 协议)：**

作用：普通的 HTTP 请求是“一来一回”的，而 WebSocket 是一条“保持连接的双向通道”。打开它，NPM 才会放行这种升级请求。

使用建议：只要你部署的应用包含实时聊天、终端控制台 (如 code-server)、状态实时同步 (如思源笔记、Home Assistant)，必须无脑打开。

**Force SSL (强制 HTTPS)：**

作用：如果有人在浏览器里输入了没加密的 http:// 网址，NPM 会立刻给他一个 301 重定向，强行把他拽到加密的 https:// 网址上。

使用建议：永远开启。 都这个年代了，裸奔的 HTTP 协议早就该被扫进历史垃圾堆了。

**HTTP/2 Support (支持 HTTP/2 协议)：**

作用：HTTP/1.1 时代，浏览器加载 10 张图片需要排队发起 10 次请求；HTTP/2 采用了“多路复用”技术，一条通道把 10 张图片同时并发塞给你。

使用建议：强烈建议开启，开启 HTTP/2 能让例如缩略图的加载速度产生肉眼可见的质变。

**HSTS Enabled (开启严格传输安全) —— ⚠️ 危险开关：**

作用：这是一个非常霸道的安全协议。开启后，NPM 会给浏览器的请求头里塞入一句话：“在接下来的半年里，你必须且只能用 HTTPS 访问我，哪怕用户手动敲了 HTTP，你也直接在浏览器内部转成 HTTPS，绝不允许发未经加密的包。”

使用建议：HomeLab 玩家慎开！ 这相当于“破釜沉舟”。一旦你开了 HSTS，并且你的浏览器记住了，假设某天你服务器的 SSL 证书过期了你没来得及续签，或者你把 NPM 玩崩了退回了 HTTP。此时，你的浏览器会死活不让你访问你的网站（甚至连“高级-> 继续前往”的按钮都不会给你）。除非你清空浏览器底层的 HSTS 记录，否则你会被自己关在门外。

**HSTS Subdomains (HSTS 应用于子域名) —— ⚠️ 核弹级开关：**

作用：不仅主域名 example.com 锁定 HSTS，连同所有的子域名 *.example.com 全部连坐，执行同样的严格加密锁定。

使用建议：绝对不要在内网折腾阶段开启！ 它的波及范围太大，一旦证书出问题，你的整个域名下的所有服务（思源、Gitea、各种测试环境）会在你的电脑上瞬间全部罢工。只有当你的所有证书实现了 100% 完美的自动续期，且网站完全面向公众时，才适合开启。

---

[[无线网络]] 的半双工模式严重制约了传输上限
[[路由器]] 的选择很重要，特别是在内网环境下，跑到速度上限非常容易

---

配置 [[GitHub]] [[SSH]]

打开 GitHub，进入 `Settings`​->`SSH and GPG Keys`​->`New SSH Key`，按下表填入字段并提交

| 字段     | 值                                       |
| -------- | ---------------------------------------- |
| Title    | 任填                                     |
| Key type | Authentication Key                       |
| Key      | 公钥，例如 `.ssh/id_rsa.pub` ​的文件内容 |

使用以下命令验证与 GitHub 的 SSH 连接

```bash
ssh -T git@github.com
```

成功后应输出如下结果

```txt
Hi xxx! You've successfully authenticated, but GitHub does not provide shell access.
```

---

[[GitHub]] 设置用户基本信息

```bash
git config --global user.name "username"
git config --global user.email "youremail@example.com"
```

---

[[GitHub]] 配置文件路径

Global 级配置文件路径

| OS      | 路径                       |
| ------- | -------------------------- |
| Linux   | ~/.gitconfig               |
| Windows | C:/Users/\$name/.gitconfig |

示例内容

```txt
[user]
        name = HiroMuraki
        email = 419734782@qq.com
[init]
        defaultBranch = main
```

---

[[GitHub]] 打包项目命令

```bash
git archive --format=zip --output=project.zip HEAD
```

---

[[GitHub]] 取消对特定目录/文件的追踪

```bash
git rm -r --cached path/to/untrack
```

---

[[GitHub]] 创建新分支

```bash
git switch -c <branch_name>
git push -u origin <branch_name>
```

---

[[复古艺术]] 中的 [[电子束坍缩]] 效果：当电视关闭时，偏转线圈的磁场先消失（垂直方向先塌陷），导致画面变成一条横向亮线；随后电子枪停止发射，那条亮线会向中心缩短成一个亮点，最后彻底消失。开机则是这个过程的完美逆向。

---

[[Dockerfile]] 中使用缓存安装 [[Apt]] 包（以 [[gosu]] 为例）

```dockerfile
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update &&\
    apt-get install -y \
    gosu
```

---

[[Linux]] 使用命令行安装 [[Miniconda]]

```bash
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
chmod +x ./Miniconda3-latest-Linux-x86_64.sh
./Miniconda3-latest-Linux-x86_64.sh
```

---

手动安装 [[VSCode]] 服务端

在 VS Code 中点击帮助 → 关于获取 commit_id（提交），填入到以下 URL 中以下载配套的 vscode-server 端

> <https://update.code.visualstudio.com/commit>:<commit_id>/server-linux-x64/stable

```bash
mkdir "$HOME/.vscode-server/bin/$commit_id"
tar zxf "path/to/vscode-server-linux-x64.tar.gz" -C "$HOME/.vscode-server/bin/$commit_id"
```

---

配置 [[Apt]] 源为中科大源
在 `/etc/apt/sources.list.d/custom.list` 中填入以下内容

```txt
deb [arch=amd64] https://mirrors.ustc.edu.cn/ubuntu/ plucky main restricted universe multiverse
```

然后更新 Apt

```bash
sudo apt update
```

---

如在运行 [[CS1.6]] / [[CSCZ]] 等老游戏的服务器时遇到 `/home/$USER/.steam/sdk32/steamclient.so` 加载错误，可执行以下命令修复

```bash
ln -s /home/$USER/.steam/steam/steamcmd/linux32/steamclient.so /home/$USER/.steam/sdk32/
```

---

[[Termux]] 配置 [[SSH]] Server

（1）安装 openssh

```bash
pkg install openssh
```

（2）启动服务

```bash
sshd
```

（3）客户端连接

```bash
ssh -p 8022 <user>@<ip>
```

> 注意：Termux 上的 SSH Server 默认监听 8022 端口，而非常规的 22

---

[[Tmux]] 会话管理

创建新会话：

```bash
tmux new -s $session_name
```

查看运行中的会话：

```bash
tmux ls
```

分离（detach）会话：按下 `Ctrl + B`​ 后再按 `D`

重新连接会话：

```bash
tmux attach -t $session_name
```

关闭会话：

```bash
tmux kill-session -t <session_name>
```

> 也可以直接在会话中使用 `exit` 命令或 Ctrl + D 快捷键

---

为 [[Linux]] 安装 [[PowerShell]]

下载二进制包：[https://github.com/PowerShell/PowerShell/releases](https://github.com/PowerShell/PowerShell/releases)

执行以下命令解包并部署：

```bash
sudo mkdir -p /opt/microsoft/powershell/7
sudo tar zxf powershell-*-linux-*.tar.gz -C /opt/microsoft/powershell/7/
sudo chmod +x /opt/microsoft/powershell/7/pwsh
sudo ln -s /opt/microsoft/powershell/7/pwsh /usr/bin/pwsh
```

---

[[SELinux]] 修复文件标签命令：

```bash
sudo restorecon -Rv $dir
```

---

[[UFW]] 常用[[防火墙]]管理命令

```bash
# 启动
sudo ufw enable

# 关闭
sudo ufw disable

# 添加
sudo ufw allow $port/$protocol [comment 'xxx']
```

---

[[Linux]] 管理 [[文件链接]] 的常用命令

```bash
# 创建软连接
ln -s <target_path> <link_path>

# 创建硬链接
ls -s <target_path> <link_path>

# 查看实际指向
readlink <link_path>

# 查看硬链接 inode 号
ls -i

# 查看链接计数
stat <file_name>
```

---

[[Linux]] 中为用户或组添加 [[sudo]] 权限

通过对 `/etc/sudoers` 文件的修改完成

为用户添加：

```txt
root         ALL=(ALL:ALL) ALL
$username    ALL=(ALL:ALL) ALL # 添加此行
```

为组添加（以 admin 组为例）：

```txt
%admin ALL=(ALL) ALL
```

---

使用 [[netsh 1]] 管理[[端口转发]]

查看所有端口转发规则

```bash
netsh interface portproxy show all
```

创建端口转发规则

```bash
netsh interface portproxy add v4tov4 \
    listenport=$本地端口 \
    listenaddress=$本地IP \
    connectport=$目标端口 \
    connectaddress=$目标IP

```

移除端口转发规则

```bash
# 移除特定 v4tov4 转发规则

netsh interface portproxy delete v4tov4 listenport=$本地端口 listenaddress=$本地IP

# 移除所有 v4tov4 转发规则
netsh interface portproxy delete v4tov4
```

---

[netsh](keys/netsh.md) 清空所有规则的命令：`netsh interface portproxy reset`

---

用于获取 [WSL](WSL.md) 磁盘路径的 [PowerShell 1](PowerShell%201.md) 命令

```bash
Get-ChildItem HKCU:\Software\Microsoft\Windows\CurrentVersion\Lxss\ | ForEach-Object {
     $distro = Get-ItemProperty $_.PSPath
     [PSCustomObject]@{
         Name = $distro.DistributionName
         BasePath = $distro.BasePath
     }
}
```
